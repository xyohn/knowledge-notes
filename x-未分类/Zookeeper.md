# Zookeeper

1. 是什么

   * 一个分布式协调服务
   * 提供一个高可用、高可靠的一致性分布式存储
   * 用于解决分布式下通用的一致性问题

2. 为什么

   * 存储分布式系统所需的元数据
   * 分布式系统下读写存储节点且无需考虑数据一致性问题

3. 功能

   * 树形存储结构

     > 类似于 UNIX 文件系统

     * 节点ZNode

       * 临时节点

         > 如果创建临时节点的客户端与 ZooKeeper 集群失去连接，这个临时节点就会自动消失

       * 永久节点

   * Watcher通知机制

     > 客户端可订阅某个ZNode，一旦 ZNode 或者它的子节点状态发生了变化，客户端将会接到通知

4. 应用

   1. 业务集群快速选举
   2. 节点间简单通信
   3. 分布式锁

5. 最佳实践

   1. 不要往 ZooKeeper 里面写入大量数据

      > 因为 ZooKeeper 不是一个真正意义上的存储系统，只适合放少量数据，大量数据下性能会急剧下降

   2. 不要让业务系统的可用性依赖于 ZooKeeper 的可用性

      > Zookeeper是CP结构，选举过程也较慢，选举过程中不对外提供服务，会中断可用性

## 思考

1. Zoeokeeper的必要性和非必要性

   早几年接触Dubbo相关架构的应用时，接触到了Zookeeper，当时Dubbo只支持使用Zookeeper作为注册中心，且是必须组件，就对Zookeeper有了一些小好奇。

   后来在接触Kafka的时候又接触到了Zookeeper，Kafka的集群需要使用Zookeeper来存储一些元数据，也是一个必须组件。

   换句话说，在当时，想使用Dubbo，想使用Kafka，Zookeeper是必不可少的一部分

   但这是一个合理的设计吗，这很难很好评判，但在我看来，在引入一个新的应用或是新的架构时，我是更希望他的依赖服务越少约好的

   因为依赖的服务越多，复杂度就会越高，后期维护的成本也会更高，所以在技术选型上，这会是我比较看重的一部分

   就像在做分布式调度框架选型的时候，我就更偏向了xxl-job而不是elasticjob，主要的原因就是后者要依赖Zookeeper，而我们现有的技术框架并不依赖Zookeeper。为了一个分布式调度框架去部署一套高可用的Zookeeper，显得非常的笨重

   还有像分布式锁的业务，其实我个人更偏向于使用Zookeeper而不是使用Redis，主要原因是后者是AP结构，而锁最好是CP结构。但实际上在业务使用上，我还是使用Redis实现的分布式锁更多，原因是在我们的业务场景下P的概率实在是太低太低了，哪怕真的出现业务上也能有规避和修正的措施，没有必要在此牺牲可用性，也就没有必要使用Zookeeper

   所以我后面的态度一直是尽可能将Zookeeper的必要性规避成不必要性

   这几年好像新出的分布式相关组件相关框架，对依赖组件这块都有了很大的变化，Zookeeper也好像逐渐变得不必要了，就连Kafka也在新版本推出了kraft来平替Zookeeper的依赖，不少组件也支持依赖服务的插拔式平替，提供了多种支持选项(Zookeeper,Nacos,Etcd,Consul..)。这在我看来是一个很好的方向，尽可能用已有的生产上成熟的组件，是降低成本的方式，也是提升整体稳定性的方式

## 参考资料

* 极客时间-消息队列高手课