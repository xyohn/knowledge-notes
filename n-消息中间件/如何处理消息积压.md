# 如何处理消息积压

1. 是什么
   * 消息队列中存在大量未消费的消息
   * 消息消费的进度远远小于消息生产的速度

2. 为什么
   * 系统中的某个部分出现了性能问题，来不及处理上游发送的消息

3. 如何优化

   > 消息队列本身的性能要远大于业务系统的处理能力，因此无需考虑优化

   * 发送端性能优化

     * 设置合适的并发和批量大小

       > 取决于业务性质
       >
       > 对于请求类型的，天然是并发，所以优先选择并发
       >
       > 对于离线分析系统，不关心时延，更适合批量发送，用少量的并发获得更高的吞吐量

   * 消费端性能优化

     > 大部分的性能问题来自这

     > 消费的速度跟不上发送端生产消息的速度，就会造成消息积压
     >
     > 因此要尽可能保证消费端的消费性能高于生产端的发送性能

     * 优化消费业务逻辑

       > 通过批量处理等方式

     * 水平扩容，增加消费端的并发数

       > 扩容 Consumer 的实例数量的同时，必须同步扩容主题中的分区（也叫队列）数量，确保 Consumer 的实例数小于等于分区数量
       >
       > 大于是没效果的，因为在每个分区上只能支持单线程消费

4. 常见突发堆积情况

   > 通过监控易定位原因

   * 生产消息徒增，消费能力不足，需短时间内提升
     * 扩容消费端实例
     * 系统降级，减少发送方数据量
   * 大量失败消息重复消费
   * 消费端死锁或资源等待



## 参考资料

* 极客时间-消息队列高手课
